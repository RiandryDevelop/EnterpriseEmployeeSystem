name: Enterprise CI/CD Pipeline

on:
  push:
    # Adjusted to include 'master' as seen in your Azure SWA configuration
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  # --- BACKEND QUALITY GATE ---
  # Ensures .NET 8 Web API integrity before deployment
  backend-build:
    name: .NET Build & Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore & Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --no-build --verbosity normal

  # --- FRONTEND QUALITY GATE ---
  # Validates Angular build process
  frontend-build:
    name: Angular Build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install & Build Frontend
      run: |
        cd EES.UI 
        npm install
        npm run build --configuration=production

  # --- PRODUCTION DEPLOYMENT ---
  # Unified deployment job for Backend (App Service) and Frontend (SWA)
  deploy-to-azure:
    name: Production Deploy
    needs: [backend-build, frontend-build]
    # Restrict deployment to your production branches (master/main)
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 1. SECRETS MANAGEMENT: Dynamic Environment Injection
      # Securely creates the environment file using GitHub Secrets
      # This satisfies the "No Hardcoded Credentials" requirement.
      - name: Generate Frontend Environment File
        run: |
          mkdir -p EES.UI/src/environments
          echo "export const environment = { 
            production: true, 
            apiUrl: '${{ secrets.API_URL }}', 
            appInsightsKey: '${{ secrets.APP_INSIGHTS_KEY }}' 
          };" > EES.UI/src/environments/environment.prod.ts

      # 2. INFRASTRUCTURE ACCESS: Azure Login
      # Uses the Service Principal credentials stored in GitHub
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. BACKEND DEPLOYMENT: Azure App Service
      # Deploys the .NET 8 API to the 'app-ees-api' resource
      - name: Deploy Backend to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'app-ees-api'
          package: .

      # 4. FRONTEND DEPLOYMENT: Azure Static Web App (SWA)
      # Deploys the Angular app using the implementation token from Azure
      - name: Deploy Frontend to Azure SWA
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/EES.UI" # Angular project subfolder
          output_location: "dist/ees-ui" # Must match 'outputPath' in your angular.json
          app_build_command: "npm run build -- --configuration=production"